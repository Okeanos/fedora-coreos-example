# https://coreos.github.io/butane/specs/
variant: fcos
version: 1.4.0
ignition:
  security:
    tls:
      certificate_authorities:
        - local: certs/ca.cert.pem
storage:
  # see https://coreos.github.io/ignition/operator-notes/#filesystem-reuse-semantics
  # whether /dev/sd* or /dev/nvme* is to be used depends on the kind of block device
  # see https://docs.fedoraproject.org/en-US/fedora-coreos/storage/#_referencing_block_devices_from_ignition
  disks:
    - device: /dev/sdb
      wipe_table: false
      partitions:
        - size_mib: 0
          start_mib: 0
          label: docker
          should_exist: true
          wipe_partition_entry: false
          number: 1
          guid: 84c9b6d3-6df7-4abb-82a5-78fc3ed9569d
    - device: /dev/sdc
      wipe_table: false
      partitions:
        - size_mib: 0
          start_mib: 0
          label: app
          should_exist: true
          wipe_partition_entry: false
          number: 1
          guid: d85bbbb8-b085-4d91-b584-147224d1b091
  # see https://coreos.github.io/ignition/operator-notes/#filesystem-reuse-semantics
  filesystems:
    - path: /var/lib/docker
      device: /dev/disk/by-partlabel/docker
      format: xfs
      wipe_filesystem: false
      with_mount_unit: true
    - path: /var/app/data
      device: /dev/disk/by-partlabel/app
      format: xfs
      wipe_filesystem: false
      with_mount_unit: true
  files:
    # See https://github.com/coreos/fcct/issues/34#issuecomment-597958199
    # See https://github.com/coreos/fedora-coreos-tracker/issues/333
    - path: /etc/hostname
      mode: 420
      overwrite: true
      contents:
        inline: |
          etcd-2
    # See https://developer.gnome.org/NetworkManager/stable/nm-settings-keyfile.html
    # See https://developer.gnome.org/NetworkManager/stable/ref-settings.html
    # See https://www.szakmeister.net/blog/2017/jun/1/static-ip-nmcli/
    # TODO in case you want an _additional_ static IPv4 address, uncomment the following block
#    - path: /etc/NetworkManager/system-connections/ens192.nmconnection
#      mode: 0600
#      overwrite: true
#      contents:
#        inline: |
#          [connection]
#          id=ens192
#          type=ethernet
#          interface-name=ens192
#          [ipv4]
#          addresses=192.168.1.8/24
#          method=auto
    - path: /etc/systemd/system.conf.d/10-default-env.conf
      mode: 0644
      contents:
        local: systemd/default-environment.conf
    # TODO Change the cluster token before deployment to the same static (random) value across all etcd instances
    # TODO Replace etcd_cluster_state=new with etcd_cluster_state=existing once the cluster finished bootstrapping
    - path: /etc/systemd/system.conf.d/11-default-env.conf
      append:
        - inline: |
            [Manager]
            DefaultEnvironment="etcd_cluster_state=new"
            DefaultEnvironment="etcd_cluster_token=d18b3bf9-e6eb-4e99-8cde-ad498340c8ca"
            DefaultEnvironment="etcd_peer_addresses=etcd-1=https://etcd-1.local:2380,etcd-2=https://etcd-2.local:2380,etcd-3=https://etcd-3.local:2380"
            DefaultEnvironment="app_name=etcd-2"
            DefaultEnvironment="app_domain_internal=etcd-2.local"
    - path: /etc/zincati/config.d/51-rollout-wariness.toml
      contents:
        inline: |
          [identity]
          rollout_wariness = 0.5
    - path: /etc/zincati/config.d/55-updates-strategy.toml
      contents:
        inline: |
          [updates]
          strategy = "periodic"
          [[updates.periodic.window]]
          days = [ "Tue", "Wed" ]
          start_time = "20:30"
          length_minutes = 60
    - path: /etc/fedora-coreos-pinger/config.d/99-disable-reporting.toml
      mode: 0644
      contents:
        inline: |
          [reporting]
          enabled = false
    - path: /etc/locale.conf
      mode: 0644
      contents:
        inline: |
          LANG=en_US.UTF-8
    - path: /etc/ssh/sshd_config.d/40-host-certificates.conf
      mode: 0600
      append:
        - local: sshd_config.d/40-host-certificates.conf
    - path: /etc/ssh/sshd_config.d/40-ssh-audit.conf
      mode: 0600
      append:
        - local: sshd_config.d/40-ssh-audit.conf
    - path: /etc/ssh/sshd_config.d/40-user-certificates.conf
      mode: 0600
      append:
        - local: sshd_config.d/40-user-certificates.conf
    - path: /etc/ssh/ssh_host_ecdsa_key
      mode: 0600
      append:
        - local: ssh/ssh_host_ecdsa_key
    - path: /etc/ssh/ssh_host_ecdsa_key-cert.pub
      mode: 0644
      append:
        - local: ssh/ssh_host_ecdsa_key-cert.pub
    - path: /etc/ssh/ssh_host_ecdsa_key.pub
      mode: 0644
      append:
        - local: ssh/ssh_host_ecdsa_key.pub
    - path: /etc/ssh/ssh_host_ed25519_key
      mode: 0600
      append:
        - local: ssh/ssh_host_ed25519_key
    - path: /etc/ssh/ssh_host_ed25519_key-cert.pub
      mode: 0644
      append:
        - local: ssh/ssh_host_ed25519_key-cert.pub
    - path: /etc/ssh/ssh_host_ed25519_key.pub
      mode: 0644
      append:
        - local: ssh/ssh_host_ed25519_key.pub
    - path: /etc/ssh/ssh_host_rsa_key
      mode: 0600
      append:
        - local: ssh/ssh_host_rsa_key
    - path: /etc/ssh/ssh_host_rsa_key-cert.pub
      mode: 0644
      append:
        - local: ssh/ssh_host_rsa_key-cert.pub
    - path: /etc/ssh/ssh_host_rsa_key.pub
      mode: 0644
      append:
        - local: ssh/ssh_host_rsa_key.pub
    # https://docs.fedoraproject.org/en-US/quick-docs/using-shared-system-certificates/
    # https://docs.fedoraproject.org/en-US/fedora-coreos/storage/#_immutable_read_only_usr
    - path: /etc/pki/ca-trust/source/anchors/root.local.pem
      mode: 0644
      overwrite: true
      contents:
        local: certs/ca.cert.pem
    - path: /var/home/core/.bashrc.d/extra.sh
      mode: 0644
      append:
        - local: user/bash_extra.sh
    - path: /var/home/core/.inputrc
      mode: 0644
      contents:
        local: user/.inputrc
    - path: /var/home/core/.virc
      mode: 0644
      contents:
        local: user/.virc
    - path: /var/app/data/certs/ca.cert.pem
      mode: 0644
      overwrite: true
      contents:
        local: certs/ca.cert.pem
    - path: /var/app/data/certs/app.cert.pem
      mode: 0644
      overwrite: true
      contents:
        local: certs/app.cert.pem
    - path: /var/app/data/certs/app.cert-chain.pem
      mode: 0644
      overwrite: true
      contents:
        local: certs/app.cert-chain.pem
    - path: /var/app/data/certs/app.key.pem
      mode: 0644
      overwrite: true
      contents:
        local: certs/app.key.pem
systemd:
  units:
    # See https://docs.fedoraproject.org/en-US/fedora-coreos/os-extensions/
    - name: rpm-ostree-install-tools.service
      enabled: true
      contents: |
        [Unit]
        Description=Layer additional tools with rpm-ostree
        # We run after `systemd-machine-id-commit.service` to ensure that
        # `ConditionFirstBoot=true` services won't rerun on the next boot.
        After=systemd-machine-id-commit.service
        After=network-online.target
        # We run before `zincati.service` to avoid conflicting rpm-ostree
        # transactions.
        Before=zincati.service
        ConditionPathExists=!/var/lib/%N.stamp
        [Install]
        WantedBy=multi-user.target
        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=rpm-ostree install --allow-inactive open-vm-tools langpacks-en
        ExecStart=/bin/touch /var/lib/%N.stamp
        ExecStart=/bin/systemctl --no-block reboot
    - name: docker-cleanup.service
      enabled: true
      contents: |
        [Unit]
        Description=Clean up Docker
        Documentation=https://docs.docker.com/engine/reference/commandline/system_prune/
        Requires=network-online.target docker.service
        After=network-online.target docker.service
        [Install]
        WantedBy=multi-user.target
        [Service]
        Type=oneshot
        ExecStart=-/bin/docker system prune -f
    - name: docker-app-network.service
      enabled: true
      contents: |
        [Unit]
        Description=Docker application network
        Documentation=https://docs.docker.com/engine/reference/commandline/network_create/
        Requires=docker.service docker-cleanup.service
        After=docker.service docker-cleanup.service
        ConditionPathExists=/var/lib/rpm-ostree-install-tools.stamp
        [Install]
        WantedBy=multi-user.target
        RequiredBy=docker-etcd.service
        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=-/bin/docker network create --driver bridge --subnet=172.28.0.0/16 "${app_network}"
    - name: docker-etcd.service
      enabled: true
      contents: |
        [Unit]
        Description=etcd in Docker
        Documentation=https://etcd.io/docs/
        Requires=docker.service docker-app-network.service
        After=docker.service docker-app-network.service
        [Install]
        WantedBy=multi-user.target
        [Service]
        TimeoutStartSec=600
        ExecStartPre=/bin/docker pull "${etcd_container}"
        ExecStartPre=-/bin/docker stop %N
        ExecStartPre=-/bin/docker rm %N
        ExecStart=/bin/docker run --name %N --hostname %N \
          --network "${app_network}" \
          --log-driver=json-file \
          --log-opt max-size=20m \
          --log-opt max-file=7 \
          -p 2379:2379 -p 2380:2380 \
          -v /var/app/data/certs:/certs:z \
          -v /var/app/data/etcd/data:/etcd-data:Z \
          -e ETCD_NAME="${app_name}" \
          -e ETCD_DATA_DIR="/etcd-data" \
          -e ETCD_LOG_OUTPUTS="stdout" \
          -e ETCD_LISTEN_CLIENT_URLS="https://0.0.0.0:2379" \
          -e ETCD_ADVERTISE_CLIENT_URLS="https://${app_domain_internal}:2379" \
          -e ETCD_LISTEN_PEER_URLS="https://0.0.0.0:2380" \
          -e ETCD_INITIAL_ADVERTISE_PEER_URLS="https://${app_domain_internal}:2380" \
          -e ETCD_INITIAL_CLUSTER="${etcd_peer_addresses}" \
          -e ETCD_INITIAL_CLUSTER_STATE="${etcd_cluster_state}" \
          -e ETCD_INITIAL_CLUSTER_TOKEN="${etcd_cluster_token}" \
          -e ETCD_CLIENT_CERT_AUTH="true" \
          -e ETCD_TRUSTED_CA_FILE="/certs/ca.cert.pem" \
          -e ETCD_CERT_FILE="/certs/app.cert-chain.pem" \
          -e ETCD_KEY_FILE="/certs/app.key.pem" \
          -e ETCD_PEER_CLIENT_CERT_AUTH="true" \
          -e ETCD_PEER_TRUSTED_CA_FILE="/certs/ca.cert.pem" \
          -e ETCD_PEER_CERT_FILE="/certs/app.cert-chain.pem" \
          -e ETCD_PEER_KEY_FILE="/certs/app.key.pem" \
          -e ETCD_PEER_CERT_ALLOWED_CN="etcd" \
          -e ETCDCTL_ENDPOINTS="${etcd_client_addresses}" \
          -e ETCDCTL_INSECURE_SKIP_TLS_VERIFY="false" \
          -e ETCDCTL_CACERT="/certs/ca.cert.pem" \
          -e ETCDCTL_CERT="/certs/app.cert-chain.pem" \
          -e ETCDCTL_KEY="/certs/app.key.pem" \
          "${etcd_container}" \
          /usr/local/bin/etcd
        ExecStop=/bin/docker stop %N
passwd:
  users:
    - name: core
      ssh_authorized_keys:
        - insert your public key here # TODO insert your public SSH key here
